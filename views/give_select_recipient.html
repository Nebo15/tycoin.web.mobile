<script id="header_template" type="text/x-handlebars-template">
  <a class="button-prev">Back</a>
  <a class="button" id="backpane">
    <i class="icon-reorder"></i>
    <span class="count-negative">0</span>
  </a>
  <h1 class="title">Give</h1>
</script>

<script id="content_template" type="text/x-handlebars-template">
  <ul class="list compact">
    <li class="list-divider">Facebook friends</li>
    {{#users}}
    <li uid="{{uid}}">
      <img src="{{image_50}}" style="width: 40px; vertical-align: middle;"/>
      {{name}}
      <a class="button-positive" style="display:none">Confirm</a>
      <span class="chevron"></span>
    </li>
    {{/users}}
  </ul>
</script>

<script type="text/javascript">
  Navigation.setMenuActivePage('give');
  var response_cache;

  $(document).one('pageLoadSuccess', function(event) {
    if(!response_cache) {
      API.request('GET', '/social/facebook_friends')
        .success(function(response) {
          response_cache = response;
          event.renderer({users:response.data.result});
        })
        .send();
    } else {
      event.renderer({users:response_cache.data.result});
    }
  });

  $(document).one('pageRender', function() {
    $('li[uid]').tap(function() {

       $('li[uid]').each(function() {
         $(this).children('.button-positive').hide();
         $(this).children('.chevron').show();
       });
       $(this).children('.chevron').hide();
       $(this).children('.button-positive').show().tap(function()
       {
         var uid = $(this).parent('li[uid]').attr('uid');
         var coin_type = Page.getParam('coin_type');
         Loader.show('Sending coins');

         API.request('POST', '/transaction/transfer', {'uid': uid, 'type': coin_type == "big" ? "big" : "usual", message:'transfer'})
          .success(function(response) {
            var post_url = "https://www.facebook.com/dialog/feed?" +
                            "to=" + uid + "&" +
                            "app_id=" + Config.fbAppId + "&" +
                            "picture=http://" + Config.host + "/images/" + Page.getParam('coin_type') + "-coin.jpg&" +
                            "name=Thank%20you!&" +
                            "link=http://" + Config.host + "/og/coin_" + Page.getParam('coin_type') + ".html" +
                            "redirect_uri=http://" + Config.host + "/transaction/fallback_from_posting";

            window.location.href = post_url;
            window.handleOpenURL = function(url) {
              setTimeout(function() {
                alert('Coins was sent');
                Navigation.redirectToDefaultPage();
              }, 100);
            };
          })
          .send();
       });
    });
  });
</script>
